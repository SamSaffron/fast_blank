#!/usr/bin/env ruby
$: << File.dirname(__FILE__)+'/lib'
require 'benchmark/ips'
require 'fast_blank'

class String
  BLANK_RE = /\A[[:space:]]*\z/

  # active support implementation
  def slow_blank?
    /\A[[:space:]]*\z/ === self
  end

  def new_slow_blank?
    empty? || BLANK_RE.match?(self)
  end
end

test_strings = [
  "",
  "\r\n\r\n  ",
  "this is a test",
  "   this is a longer test",
  "   this is a longer test
      this is a longer test
      this is a longer test
      this is a longer test
      this is a longer test"
]

test_strings.each do |s|
  raise "failed on #{s.inspect}" if s.blank? != s.slow_blank?
  raise "failed on #{s.inspect}" if s.blank? != s.new_slow_blank?
end

test_strings.each do |s|
  puts "\n================== Test String Length: #{s.length} =================="
  Benchmark.ips do |x|
    x.report("Fast Blank") do |times|
      i = 0
      while i < times
        s.blank?
        i += 1
      end
    end

    x.report("Fast ActiveSupport") do |times|
      i = 0
      while i < times
        s.blank_as?
        i += 1
      end
    end

    x.report("Slow Blank") do |times|
      i = 0
      while i < times
        s.slow_blank?
        i += 1
      end
    end

    x.report("New Slow Blank") do |times|
      i = 0
      while i < times
        s.new_slow_blank?
        i += 1
      end
    end

    x.compare!
  end
end

# ================== Test String Length: 0 ==================
# Warming up --------------------------------------
#           Fast Blank     2.811M i/100ms
#   Fast ActiveSupport     2.775M i/100ms
#           Slow Blank   319.479k i/100ms
#       New Slow Blank     2.590M i/100ms
# Calculating -------------------------------------
#           Fast Blank     28.309M (± 0.7%) i/s -    143.355M in   5.064154s
#   Fast ActiveSupport     27.885M (± 0.7%) i/s -    141.517M in   5.075252s
#           Slow Blank      3.209M (± 1.0%) i/s -     16.293M in   5.077717s
#       New Slow Blank     26.017M (± 0.9%) i/s -    132.115M in   5.078494s

# Comparison:
#           Fast Blank: 28309178.6 i/s
#   Fast ActiveSupport: 27884928.2 i/s - 1.02x  slower
#       New Slow Blank: 26016869.2 i/s - 1.09x  slower
#           Slow Blank:  3209138.7 i/s - 8.82x  slower


# ================== Test String Length: 6 ==================
# Warming up --------------------------------------
#           Fast Blank     1.609M i/100ms
#   Fast ActiveSupport     1.563M i/100ms
#           Slow Blank   278.445k i/100ms
#       New Slow Blank   848.522k i/100ms
# Calculating -------------------------------------
#           Fast Blank     15.916M (± 1.9%) i/s -     80.437M in   5.056039s
#   Fast ActiveSupport     15.593M (± 1.9%) i/s -     78.128M in   5.012318s
#           Slow Blank      2.894M (± 1.3%) i/s -     14.479M in   5.004609s
#       New Slow Blank      8.521M (± 1.2%) i/s -     43.275M in   5.079181s

# Comparison:
#           Fast Blank: 15915513.5 i/s
#   Fast ActiveSupport: 15592918.2 i/s - same-ish: difference falls within error
#       New Slow Blank:  8521250.6 i/s - 1.87x  slower
#           Slow Blank:  2893641.0 i/s - 5.50x  slower


# ================== Test String Length: 14 ==================
# Warming up --------------------------------------
#           Fast Blank     2.642M i/100ms
#   Fast ActiveSupport     2.541M i/100ms
#           Slow Blank   616.028k i/100ms
#       New Slow Blank   943.087k i/100ms
# Calculating -------------------------------------
#           Fast Blank     26.282M (± 0.8%) i/s -    132.078M in   5.025646s
#   Fast ActiveSupport     25.314M (± 1.2%) i/s -    127.038M in   5.019340s
#           Slow Blank      6.094M (± 2.1%) i/s -     30.801M in   5.056336s
#       New Slow Blank      9.414M (± 1.0%) i/s -     47.154M in   5.009560s

# Comparison:
#           Fast Blank: 26282498.1 i/s
#   Fast ActiveSupport: 25313579.3 i/s - 1.04x  slower
#       New Slow Blank:  9413905.4 i/s - 2.79x  slower
#           Slow Blank:  6094343.2 i/s - 4.31x  slower


# ================== Test String Length: 24 ==================
# Warming up --------------------------------------
#           Fast Blank     1.945M i/100ms
#   Fast ActiveSupport     1.899M i/100ms
#           Slow Blank   550.633k i/100ms
#       New Slow Blank   788.512k i/100ms
# Calculating -------------------------------------
#           Fast Blank     19.399M (± 1.0%) i/s -     97.259M in   5.014145s
#   Fast ActiveSupport     18.903M (± 0.7%) i/s -     94.958M in   5.023799s
#           Slow Blank      5.486M (± 1.0%) i/s -     27.532M in   5.019220s
#       New Slow Blank      7.772M (± 1.3%) i/s -     39.426M in   5.073728s

# Comparison:
#           Fast Blank: 19399137.3 i/s
#   Fast ActiveSupport: 18902692.5 i/s - 1.03x  slower
#       New Slow Blank:  7771936.7 i/s - 2.50x  slower
#           Slow Blank:  5485855.2 i/s - 3.54x  slower


# ================== Test String Length: 136 ==================
# Warming up --------------------------------------
#           Fast Blank     1.937M i/100ms
#   Fast ActiveSupport     1.885M i/100ms
#           Slow Blank   549.012k i/100ms
#       New Slow Blank   790.087k i/100ms
# Calculating -------------------------------------
#           Fast Blank     19.401M (± 0.6%) i/s -     98.807M in   5.093149s
#   Fast ActiveSupport     18.916M (± 1.0%) i/s -     96.139M in   5.082984s
#           Slow Blank      5.491M (± 1.0%) i/s -     28.000M in   5.099366s
#       New Slow Blank      7.864M (± 0.6%) i/s -     39.504M in   5.023416s

# Comparison:
#           Fast Blank: 19400820.9 i/s
#   Fast ActiveSupport: 18915679.7 i/s - 1.03x  slower
#       New Slow Blank:  7864288.1 i/s - 2.47x  slower
#           Slow Blank:  5491367.9 i/s - 3.53x  slower
